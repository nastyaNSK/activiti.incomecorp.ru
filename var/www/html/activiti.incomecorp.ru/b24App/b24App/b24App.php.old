<?php
namespace b24App;
use systems;

define('EXT_APP', __DIR__."/app/");//Application key


class b24App extends b24AppSys
{

    function __construct() {
        parent::__construct();
//        systems::lvd($_POST);
//        systems::lvd($_GET);

    }
    public function activitySwitch()
    {
        if(isset($_REQUEST['member_id'])) {
            $this->setPortalDomain($_REQUEST['member_id']);
            if(isset($_REQUEST['code']))
            {
                $e = explode(".", $_REQUEST['code']);
                $file = isset($e[1]) ? $e[1] :  $_REQUEST['code'];
                systems::lvd("++".$file."++");
                if(is_file(EXT_APP . strtolower($file.".php")))
                {
                    $app = require(EXT_APP . strtolower($file.".php"));
                    $app['install']($this);
                    echo json_encode(["result" => "ok"]);
                    return;
                }else{
                    systems::lvd($_REQUEST);
                    systems::lvd(is_file(EXT_APP . strtolower($_REQUEST['code'].".php")));
                }
            }
        }
    }
    public function supportQuery()
    {
        if(isset($_REQUEST['member_id'])) {

            $to  = "<spambox616@yandex.ru>" ;
            $subject = "Запрс из приложения";
            $message = ' 
                        Адрес пользователя:' .$_REQUEST['DOMAIN'] .' <br><br>
                        Email '.$_REQUEST['EMAIL'].'<br><hr>
                        '.$_REQUEST['supportrequest'].'
                ';
            $headers = "From: От кого письмо <portal@income-media.ru>\r\n";


            mail($to, $subject, $message, $headers);
            echo json_encode(["result" => "ok"]);
        }

    }


    public function handler()
    {
//        systems::lvd("=========== HANDLER ==========");
////
  //      systems::lvd($_REQUEST);

        if(isset($_REQUEST["PLACEMENT"]) && $_REQUEST["PLACEMENT"] == "DEFAULT" ){

            $activity = self::getActivityDataByFiles();
            $handlerBackUrl = "https://activiti.incomecorp.ru/b24-activity-switch/";
            $supportBackUrl = "https://activiti.incomecorp.ru/b24-support-query/";
            $BackUrl = "https://activiti.incomecorp.ru/";

            require_once (__DIR__."/forms/default.php");
        }


        if(isset($_REQUEST["auth"]['member_id'])){
            $this->setPortalDomain($_REQUEST["auth"]['member_id']);

            if(isset($_REQUEST['event']))
            {
                $f = $_REQUEST['event'];
                if(function_exists($f))
                    $f();
                return;
            }

            if(isset($_REQUEST['code']))
            {
                $e = explode(".", $_REQUEST['code']);
                $file = isset($e[1]) ? $e[1] :  $_REQUEST['code'];
                //systems::lvd($file);
                if(is_file(EXT_APP . strtolower($file.".php")))
                {
                    $app = require(EXT_APP . strtolower($file.".php"));
                    $app['handler']($this);
                    return;
                }
            }
        }
    }

    public function log($str)
    {
        systems::lvd($str);
    }

    public function webhook()
    {

    }

    public function b24test()
    {
        ini_set('error_reporting', E_ALL);
        ini_set('display_errors', 1);
        ini_set('display_startup_errors', 1);
        systems::lvd("test");
    }




    public function installApp()
    {

        $resultInstall = $this->install();

        /**  if || true instsall all activitis */
        if($resultInstall['install'] == true && false) {
            $this->b24Demoronization();
            $this->setPortalDomain($_REQUEST['member_id']);
            $dir = scandir(EXT_APP);
            foreach ($dir as $item) {
                if (is_file(EXT_APP . $item)) {
                    $app = require(EXT_APP . $item);
                    $app['install']($this);
                }
            }
        }



        if($resultInstall['rest_only'] === false):?>
        <head>
            <script src="//api.bitrix24.com/api/v1/"></script>
            <?php if($resultInstall['install'] == true):?>
                <script>
                    BX24.init(function(){
                        BX24.installFinish();
                    });
                </script>
            <?php endif;?>
        </head>
        <body>
        <?php if($resultInstall['install'] == true):?>
            !!!!! installation has been finished
        <?php else:?>
            installation error
        <?php endif;?>
        </body>
        <?php endif;



    }

    public static function getActivityDataByFiles()
    {
        $dir = scandir(EXT_APP);
        $arResult =[];
        foreach ($dir as $item) {
            if (is_file(EXT_APP . $item)) {

                $app = require(EXT_APP . $item);
                if(isset($app['data']))
                {
                    $arResult[] =  $app['data'];
                }else{
                    $r['activityDescription'] =  $r['activityCode'] =  $r['activityName'] = strtoupper(explode(".", $item)[0]);
                    $arResult[] = $r;

                }

            }
        }
        return $arResult;
    }


}
